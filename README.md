# 弱网测试## 概念弱网测试是健壮性测试的一个专项。我们日常生活中在网络条件不好的情况下，例如经过地下通道，地铁，或是偏远地区。这时候，这时候，手机应用程序如果，在访问网络的过程中，出现崩溃等情况就会很影响用户体验。在例如大公司机房之间通讯，可能两个地方相聚很远甚至在国外。这时候，两者之间也会网路可能出现相对比较大的延时、抖动等问题。这是需要通过弱网测试来，提高程序的健壮性。## 行业软件分析在弱网测试这一块，facebook研发出专门用于手机弱网测试的[augmented-traffic-control](https://github.com/facebook/augmented-traffic-control)，`charles`和`fiddler`软件也有弱网功能的实现。你甚至能在chrome中，发现不同网络环境模拟的配置选项。像腾讯等国内大厂也有相关内部工具的使用。应用其实很广泛。## augmented-traffic-control弱网原理分析利用了Linux流量控制系统，通过`linux` - `iptables`命令, `tc`命令进行网络流量控制。使用iptables命令将经过`mangle表`的固定IP或端口的数据包做标记，然后使用`tc`命令对标记数据包进行`带宽限制`、`时延抖动`、`丢包`、`错包`、`包重排`等流量控制，从而达到针对固定IP实现流量控制的目的。## linux 命令演示将从22.22.22.22服务器发来的请求数据打上标记。```shell# 将mangle表里的规则清空iptables -t mangle -F OUTPUT # 给OUTPUT链的mangle表添加规则：将从22.22.22.22发到本地bond0端口的请求这是标记0x1。iptables -t mangle -A OUTPUT -d 22.22.22.22 -o eth0 -j MARK --set-mark 0x1```使用`tc`命令给打上标记的数据包做限流。命令如下：```shell# 清空 eth0网卡根目录的队列规则tc qdisc del dev eth0 root # 给eth0网卡添加根节点队列规则，规则类型为htb(层级令牌桶），名称为“1：”tc qdisc add dev eth0 root handle 1: htb # 给根节点添加名称为“1：1”的类， 类型为htb(层级令牌桶），带宽为20000Mbit/secondtc class add dev eth0 parent 1: classid 1:1 htb rate 20000Mbit # 在名称为“1：1”的类上，添加队列规则，使用netem命令设置丢包率为50%。tc qdisc add dev eth0 parent 1:1 netem loss 50% # 在“1：”的队列规则上设置凡是被标记有0x1的数据经过该规则时，优先级为1（0最高，最低为7），将由类“1：1”来处理，入口限流，带宽为20000Mbit，允许的突发数据为12000b.tc filter add dev eth0 protocol ip parent 1: prio 1 handle 0x1 fw  classid 1:1 police rate 20000Mbit burst 12000b drop```我们现在来验证一下结果：```shell[root@localhost ~]# ping 22.22.22.22PING 22.22.22.22 (22.22.22.22) 56(84) bytes of data.64 bytes from 22.22.22.22: icmp_seq=2 ttl=64 time=0.176 ms64 bytes from 22.22.22.22: icmp_seq=7 ttl=64 time=0.135 ms64 bytes from 22.22.22.22: icmp_seq=9 ttl=64 time=0.163 ms64 bytes from 22.22.22.22: icmp_seq=12 ttl=64 time=0.163 ms64 bytes from 22.22.22.22: icmp_seq=13 ttl=64 time=0.174 ms64 bytes from 22.22.22.22: icmp_seq=14 ttl=64 time=0.172 ms64 bytes from 22.22.22.22: icmp_seq=15 ttl=64 time=0.162 ms--- 22.22.22.22 ping statistics ---16 packets transmitted, 7 received, 56% packet loss, time 15268msrtt min/avg/max/mdev = 0.135/0.163/0.176/0.018 ms```可以看到packet loss比例接近于50%的设置值，符合预期。说明设置成功。## 常用的iptables和tc命令### iptables常用命令显示iptables上的链表规则信息“-L” 参数列出链中的规则, 因为没有指定链名, 所以预设列出 filter 链的规则“-v” 参数将显示完整的信息, 以便观察传输量统计的状况, 一般不使用”-v “参数时, 只会显示如来源地址等简要的信息“-n” 参数设定 iptables 不要将 IP 反查为域名		**iptables -nv -L**### tc常用命令：显示eth0网卡上的过滤器信息**tc filter show dev eth0** 显示eth0上的类信息**tc class show dev eth0** 显示eth0上的队列信息**tc qdisc show dev eth0**